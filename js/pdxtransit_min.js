function routelist(){downloadUrl("http://developer.trimet.org/ws/V1/routeConfig/appID/D17CB46A14E7BEE1CBA6598AA",function(e){var t=xmlParse(e);var n=t.getElementsByTagName("route");var r='<div class="input-group-btn"><button type="button" id="btnRoute1" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Choose Route<span class="caret"></span></button><ul class="dropdown-menu" id="ulRoute1"  role="menu">';for(var i=0;i<n.length;i++){var s=n[i];var o=s.getAttribute("desc");var u=s.getAttribute("route");var a=s.getAttribute("type");r+="<li class='li1'><a href='javascript:routeDirList("+u+")'>"+o+"</a></li>"}r+="</ul></div>";document.getElementById("route_options").innerHTML=r})}function routeDirList(e){var t="http://developer.trimet.org/ws/V1/routeConfig/route/"+e+"/dir/true/stops/true/appid/D17CB46A14E7BEE1CBA6598AA";downloadUrl(t,function(t){var n=xmlParse(t);var r=n.getElementsByTagName("dir");var i='<div class="input-group-btn"><button type="button" id="btnRoute2" class="btn btn-default dropdown-toggle" data-toggle="dropdown" href="#">Direction<span class="caret"></span></button><ul class="dropdown-menu" id="ulRoute2"  role="menu">';for(var s=0;s<r.length;s++){var o=r[s];var u=o.getAttribute("dir");var a=o.getAttribute("desc");i+="<li class='li2'><a href='javascript:routeload1("+e+", "+u+")'>"+a+"</a></li>"}i+="</ul></div>";document.getElementById("route_dir_options").innerHTML=i})}function deleteStopMarkers(){if(stopMarkers){for(i=0;i<stopMarkers.length;i++){map.removeLayer(stopMarkers[i])}stopMarkers.length=0}}function deleteClickMarkers(){if(clickMarkers){for(i=0;i<clickMarkers.length;i++){map.removeLayer(clickMarkers[i])}clickMarkers.length=0}if(typeof positionMarkers[0]!="undefined"){positionMarkers[0].setOpacity(0)}}function deleteCloseStopMarkers(){if(closeStopMarkers){for(i=0;i<closeStopMarkers.length;i++){map.removeLayer(closeStopMarkers[i])}closeStopMarkers.length=0}}function deleteall(){deleteStopMarkers();deleteClickMarkers();deleteCloseStopMarkers();if(closeStopMarkerNew)map.removeLayer(closeStopMarkerNew);if(stopNewMarker)map.removeLayer(stopNewMarker);markerGroup.clearLayers()}function routeload2(e){downloadUrl("http://developer.trimet.org/ws/V1/routeConfig/appID/D17CB46A14E7BEE1CBA6598AA",function(e){var t=xmlParse(e);var n=t.getElementsByTagName("route");for(var r=0;r<n.length;r++){var i=n[r];var s=i.getAttribute("desc");var o=i.getAttribute("route")}})}function routeload1(e,t){routeload1nStopload(e,t);var n="http://developer.trimet.org/ws/V1/routeConfig/route/"+e+"/dir/"+t+"/stops/true/appid/D17CB46A14E7BEE1CBA6598AA";deleteStopMarkers();stopMarkers=[];downloadUrl(n,function(e){var t=xmlParse(e);var n=t.getElementsByTagName("route")[0].getAttribute("desc");var r=t.getElementsByTagName("dir")[0].getAttribute("desc");$("#btnRoute1:first-child").text(n);$("#btnRoute2:first-child").text(r);var i=t.getElementsByTagName("stop");clearTimeout(vv);for(var s=0;s<i.length;s++){var o=i[s];var u=o.getAttribute("desc");var a=o.getAttribute("dir");var f=o.getAttribute("locid");var l=o.getAttribute("desc");var c=parseFloat(o.getAttribute("lat"));var h=parseFloat(o.getAttribute("lng"));var p=L.icon({iconUrl:"images/orange16.png",iconSize:[16,16],iconAnchor:[8,8]});var d={title:l,clickable:true,icon:p};stopMarker=new L.marker([c,h],d);markerGroup.addLayer(stopMarker);var v="<b>Stop ID:</b>"+f+"<br /><b>Stop:</b>"+l+"<br/><a href='javascript:loadArrivalInfo("+f+")'>Next Arrivals</a>";var m="<div><a href='javascript:loadArrivalInfo2("+f+")'>Scheduled Arrivals</a></div>";var g=v+m;stopMarker.bindPopup(g).openPopup();stopMarkers.push(stopMarker);map.addLayer(stopMarkers[s])}var y=new L.featureGroup(stopMarkers);map.fitBounds(y.getBounds())})}function routeload1nStopload(e,t){var n="http://developer.trimet.org/ws/V1/routeConfig/route/"+e+"/dir/"+t+"/stops/true/appid/D17CB46A14E7BEE1CBA6598AA";downloadUrl(n,function(e){var t=xmlParse(e);var n=t.getElementsByTagName("stop");var r='<div class="input-group-btn"><button type="button" id="btnRoute3" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Choose Stop<span class="caret"></span></button><ul class="dropdown-menu" id="ulRoute3" role="menu">';for(var i=0;i<n.length;i++){var s=n[i];var o=s.getAttribute("locid");var u=s.getAttribute("desc");var a=s.getAttribute("lat");var f=s.getAttribute("lng");var l=a+","+f+","+o;r+="<li class='li3'><a href='javascript:routeStopload("+l+")'>"+u+"</a></li>"}document.getElementById("routeStop_dir_options").innerHTML=r+"</ul></div>"})}function routeStopload(e,t,n){if(closeStopMarkerNew)map.removeLayer(closeStopMarkerNew);if(stopNewMarker)map.removeLayer(stopNewMarker);var r,i,s,o;console.log(n);var u="http://developer.trimet.org/ws/v2/arrivals/locids/"+n+"/appid/D17CB46A14E7BEE1CBA6598AA/json/false";downloadUrl(u,function(e){i="";var t=xmlParse(e);var n=t.getElementsByTagName("location");var r=n[0].getAttribute("desc");var s=n[0].getAttribute("dir");i="<b>"+r+": "+s+"</b><br />"});downloadUrl(u,function(e){var t=xmlParse(e);var n=t.getElementsByTagName("arrival");s="";for(var r=0;r<n.length;r++){var i=n[r];var o=i.getAttribute("route");var u=i.getAttribute("dir");var a=i.getAttribute("shortSign");var f=i.getAttribute("scheduled");var l=i.getAttribute("estimated");var c=i.getAttribute("status");if(c=="estimated"){var h=new Date(Number(l));var p=h.getHours()<10?"0"+h.getHours():h.getHours();var d=h.getMinutes()<10?"0"+h.getMinutes():h.getMinutes();var v=p+":"+d;var m=i.getAttribute("dir");s+="<div>"+"<a href='javascript:routeload1("+o+","+u+")'>"+a+"</a>: "+v+"</div>"}}console.log("Estimated"+s)});downloadUrl(u,function(n){var u=xmlParse(n);var a=u.getElementsByTagName("detour");o="";for(var f=0;f<a.length;f++){var l=a[f];var c=l.getAttribute("begin");var h=l.getAttribute("end");var p=l.getAttribute("desc");if(p){var d=new Date(Number(c));console.log(d);var v=d.getDate()+"-"+(d.getMonth()+1)+"-"+d.getFullYear();var m=d.getHours()<10?"0"+d.getHours():d.getHours();var g=d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes();var y=m+":"+g;v=v+" "+y;var b=new Date(Number(h));var w=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear();var E=b.getHours()<10?"0"+b.getHours():b.getHours();var S=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes();var x=E+":"+S;w=w+" "+x;o+="<div> Detour (from:"+v+" to: "+w+"): "+p+"</div>"}}r=i+s+"<br/>"+o;var T=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});stopNewMarker=new L.marker([e,t],{icon:T});markerGroup.addLayer(stopNewMarker);map.addLayer(stopNewMarker);stopNewMarker.bindPopup(r).openPopup()});map.setView([e,t],18)}function initialize(){function e(e){var t=e.latlng.toString().slice(7).split(", ")[0];var n=e.latlng.toString().split(", ")[1].replace(")","");deleteClickMarkers();var r=L.icon({iconUrl:"./images/redman1.png",shadowUrl:"./images/redman1_shadow.png",iconSize:[40,40],shadowSize:[38,43],iconAnchor:[22,42],shadowAnchor:[12,44],popupAnchor:[0,-40]});clickMarker=new L.marker([t,n],{draggable:true,icon:r});clickMarker.on("dragend",function(e){console.log("it is dragged");var t=e.target.getLatLng().toString().slice(7).split(", ")[0];var n=e.target.getLatLng().toString().split(", ")[1].replace(")","");loadCloseStops(t,n)});clickMarkers.push(clickMarker);markerGroup.addLayer(clickMarker);map.addLayer(clickMarkers[0]);loadCloseStops(t,n);map.setView(e.latlng,16)}function t(e){deleteClickMarkers();var t=e.latlng.toString().slice(7).split(", ")[0];var n=e.latlng.toString().split(", ")[1].replace(")","");var r=L.icon({iconUrl:"./images/redman1.png",shadowUrl:"./images/redman1_shadow.png",iconSize:[40,40],shadowSize:[38,43],iconAnchor:[22,42],shadowAnchor:[12,44],popupAnchor:[0,-40]});clickMarker=new L.marker([t,n],{icon:r,draggable:true});clickMarker.on("dragend",function(e){console.log("it is dragged");var t=e.target.getLatLng().toString().slice(7).split(", ")[0];var n=e.target.getLatLng().toString().split(", ")[1].replace(")","");loadCloseStops(t,n)});clickMarkers.push(clickMarker);markerGroup.addLayer(clickMarker);map.addLayer(clickMarkers[0]);loadCloseStops(t,n)}function n(e){alert(e.message)}$("ul").on("click","li.li1 a",function(){$("#btnRoute1:first-child").text($(this).text())});$("ul").on("click","li.li2 a",function(){$("#btnRoute2:first-child").text($(this).text())});$("ul").on("click","li.li3 a",function(){$("#btnRoute3:first-child").text($(this).text())});map=L.map("map_canvas").setView([45.529,-122.662],13);L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);(new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.Google,position:"bottomleft",showMarker:true})).addTo(map);map.on("geosearch_showlocation",function(e){thisLat=e.Location.X;thisLon=e.Location.Y;console.log(thisLat+", "+thisLon);loadCloseStops(thisLat,thisLon);if(typeof positionMarkers[0]!="undefined"){console.log("set opacity as 0.9");positionMarkers[0].setOpacity(1)}});map.on("click",e);map.locate({setView:true,maxZoom:16});map.on("locationfound",t);map.on("locationerror",n);$("#leaflet-control-geosearch-qry").attr("placeholder","Type an address to search nearby stops or click anywhere");$("#leaflet-control-geosearch-qry").hide();$("#leaflet-control-geosearch-qry").css("padding","0px");$(".leaflet-bottom.leaflet-left").css("bottom","");$(".leaflet-bottom.leaflet-left").css("top","108px");routelist("none")}function searchOpen(){$("#leaflet-control-geosearch-qry").toggle()}function loadCloseStops(e,t){deleteCloseStopMarkers();var n="http://developer.trimet.org/ws/V1/stops/ll/"+t+","+e+"/feet/500/appid/D17CB46A14E7BEE1CBA6598AA/json/false";downloadUrl(n,function(n){var r=xmlParse(n);var i=r.getElementsByTagName("location");var s="";var o=1;if(i.length>0){for(var u=0;u<i.length;u++){var a=i[u];var f=a.getAttribute("desc");var l=a.getAttribute("dir");var c=a.getAttribute("lat");var h=a.getAttribute("lng");var p=a.getAttribute("locid");s1="<div>"+f+" ("+l+") <br /><a href='javascript:loadArrivalInfo("+p+")'>Next Arrivals</a></div>";s2="<div><a href='javascript:loadArrivalInfo2("+p+")'>Scheduled Arrivals</a></div>";s=s1+s2;var d=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});closeStopMarker=new L.marker([c,h],{icon:d});closeStopMarker.bindPopup(s).openPopup();closeStopMarkers.push(closeStopMarker);markerGroup.addLayer(closeStopMarkers[u]);map.addLayer(closeStopMarkers[u])}}else{console.log("none");var v=L.popup();var m=L.latLng(e,t);v.setLatLng(m).setContent("There is no stops nearby.");clickMarker.bindPopup(v);clickMarker.openPopup()}});$("#leaflet-control-geosearch-qry").hide()}function loadArrivalInfo(e){if(closeStopMarkerNew)map.removeLayer(closeStopMarkerNew);if(stopNewMarker)map.removeLayer(stopNewMarker);var t,n,r,i;var s="http://developer.trimet.org/ws/v2/arrivals/locids/"+e+"/appid/D17CB46A14E7BEE1CBA6598AA/json/false";downloadUrl(s,function(e){n="";var t=xmlParse(e);var r=t.getElementsByTagName("location");var i=r[0].getAttribute("desc");var s=r[0].getAttribute("dir");var o=r[0].getAttribute("lat");var u=r[0].getAttribute("lng");n="<b>"+i+": "+s+"</b><br />";var a=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});closeStopMarkerNew=new L.marker([o,u],{icon:a});markerGroup.addLayer(closeStopMarkerNew)});downloadUrl(s,function(e){var t=xmlParse(e);var n=t.getElementsByTagName("arrival");r="";for(var i=0;i<n.length;i++){var s=n[i];var o=s.getAttribute("route");var u=s.getAttribute("dir");var a=s.getAttribute("shortSign");var f=s.getAttribute("scheduled");var l=s.getAttribute("estimated");var c=s.getAttribute("status");if(c=="estimated"){var h=new Date(Number(l));console.log(h);var p=h.getHours()<10?"0"+h.getHours():h.getHours();var d=h.getMinutes()<10?"0"+h.getMinutes():h.getMinutes();var v=p+":"+d;var m=s.getAttribute("dir");r+="<div>"+"<a href='javascript:routeload1("+o+","+u+")'>"+a+"</a>: "+v+"</div>"}}});downloadUrl(s,function(e){var s=xmlParse(e);var o=s.getElementsByTagName("detour");i="";for(var u=0;u<o.length;u++){var a=o[u];var f=a.getAttribute("begin");var l=a.getAttribute("end");var c=a.getAttribute("desc");if(c){var h=new Date(Number(f));console.log(h);var p=h.getDate()+"-"+(h.getMonth()+1)+"-"+h.getFullYear();var d=h.getHours()<10?"0"+h.getHours():h.getHours();var v=h.getMinutes()<10?"0"+h.getMinutes():h.getMinutes();var m=d+":"+v;p=p+" "+m;var g=new Date(Number(l));var y=g.getDate()+"-"+(g.getMonth()+1)+"-"+g.getFullYear();var b=g.getHours()<10?"0"+g.getHours():g.getHours();var w=g.getMinutes()<10?"0"+g.getMinutes():g.getMinutes();var E=b+":"+w;y=y+" "+E;i+="<div> Detour (from:"+p+" to: "+y+"): "+c+"</div>"}}t=n+r+"<br/>"+i;map.addLayer(closeStopMarkerNew);closeStopMarkerNew.bindPopup(t).openPopup()})}function loadArrivalInfo2(e){if(closeStopMarkerNew)map.removeLayer(closeStopMarkerNew);if(stopNewMarker)map.removeLayer(stopNewMarker);var t,n,r,i;var s=(new Date).getTime();var o=(new Date).getTime();o=o+864e5;var u="http://developer.trimet.org/ws/v2/arrivals/locids/"+e+"/appid/D17CB46A14E7BEE1CBA6598AA/json/false/begin/"+s+"/end/"+o;downloadUrl(u,function(e){n="";var t=xmlParse(e);var r=t.getElementsByTagName("location");var i=r[0].getAttribute("desc");var s=r[0].getAttribute("dir");var o=r[0].getAttribute("lat");var u=r[0].getAttribute("lng");n="<b>"+i+": "+s+"</b><br />";var a=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});closeStopMarkerNew=new L.marker([o,u],{icon:a});markerGroup.addLayer(closeStopMarkerNew)});downloadUrl(u,function(e){var t=xmlParse(e);var n=t.getElementsByTagName("arrival");r="";for(var i=0;i<n.length;i++){var s=n[i];var o=s.getAttribute("route");var u=s.getAttribute("dir");var a=s.getAttribute("shortSign");var f=s.getAttribute("scheduled");var l=s.getAttribute("status");if(l=="scheduled"){var c=new Date(Number(f));var h=c.getHours()<10?"0"+c.getHours():c.getHours();var p=c.getMinutes()<10?"0"+c.getMinutes():c.getMinutes();var d=h+":"+p;var v=s.getAttribute("dir");r+="<div>"+"<a href='javascript:routeload1("+o+","+u+")'>"+a+"</a>: "+d+"</div>"}}});downloadUrl(u,function(e){var s=xmlParse(e);var o=s.getElementsByTagName("detour");i="";for(var u=0;u<o.length;u++){var a=o[u];var f=a.getAttribute("begin");var l=a.getAttribute("end");var c=a.getAttribute("desc");if(c){var h=new Date(Number(f));console.log(h);var p=h.getDate()+"-"+(h.getMonth()+1)+"-"+h.getFullYear();var d=h.getHours()<10?"0"+h.getHours():h.getHours();var v=h.getMinutes()<10?"0"+h.getMinutes():h.getMinutes();var m=d+":"+v;p=p+" "+m;var g=new Date(Number(l));var y=g.getDate()+"-"+(g.getMonth()+1)+"-"+g.getFullYear();var b=g.getHours()<10?"0"+g.getHours():g.getHours();var w=g.getMinutes()<10?"0"+g.getMinutes():g.getMinutes();var E=b+":"+w;y=y+" "+E;i+="<div> Detour (from:"+p+" to: "+y+"): "+c+"</div>"}}t=n+r+"<br/>"+i;map.addLayer(closeStopMarkerNew);closeStopMarkerNew.bindPopup(t).openPopup()})}function rad(e){return e*Math.PI/180}function find_closest_marker(e){if(typeof e.latLng!="undefined"){var t=e.latLng.lat();var n=e.latLng.lng()}else{var t=e.getPosition().lat();var n=e.getPosition().lng()}var r=6371;var s=[];var o=-1;for(i=0;i<allBusStopMarkers.length;i++){var u=allBusStopMarkers[i].getPosition().lat();var a=allBusStopMarkers[i].getPosition().lng();var f=rad(u-t);var l=rad(a-n);var c=Math.sin(f/2)*Math.sin(f/2)+Math.cos(rad(t))*Math.cos(rad(t))*Math.sin(l/2)*Math.sin(l/2);var h=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));var p=r*h;s[i]=p;if(o==-1||p<s[o]){o=i}}var d=allBusStopMarkers[o].getTitle();stopload(d)}function showHelp(){if($("div").filter(".helpCallout").is(":visible")){$("div").filter(".helpCallout").fadeOut(100);return}else $("div").filter(".helpCallout").fadeIn(100)}var markers=[];var stopMarkers=[];var closeStopMarkers=[];var addressMarkers=[];var allBusStopMarkers=[];var closeStopMarkers=[];var clickMarkers=[];var polylines=[];var map,geocoder;var marker,addressMarker,clickMarker;var stopTitle;var gTag,gAgency;var tt,vv;var stopMarker,closeStopMarker,closeStopMarkerNew,stopNewMarker;var markerGroup=L.layerGroup();$(function(){$("#dialog").dialog({width:800,modal:true,stack:false})})