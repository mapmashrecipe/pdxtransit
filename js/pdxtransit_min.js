function routelist(){downloadUrl("//developer.trimet.org/ws/V1/routeConfig/appID/D17CB46A14E7BEE1CBA6598AA",function(e){for(var t=xmlParse(e),r=t.getElementsByTagName("route"),o='<div class="input-group-btn"><button type="button" id="btnRoute1" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Choose Route<span class="caret"></span></button><ul class="dropdown-menu" id="ulRoute1"  role="menu">',a=0;a<r.length;a++){var i=r[a],s=i.getAttribute("desc"),n=i.getAttribute("route");i.getAttribute("type");o+="<li class='li1'><a href='javascript:routeDirList("+n+")'>"+s+"</a></li>"}o+="</ul></div>",document.getElementById("route_options").innerHTML=o})}function routeDirList(e){var t="//developer.trimet.org/ws/V1/routeConfig/route/"+e+"/dir/true/stops/true/appid/D17CB46A14E7BEE1CBA6598AA";downloadUrl(t,function(t){for(var r=xmlParse(t),o=r.getElementsByTagName("dir"),a='<div class="input-group-btn"><button type="button" id="btnRoute2" class="btn btn-default dropdown-toggle" data-toggle="dropdown" href="#">Direction<span class="caret"></span></button><ul class="dropdown-menu" id="ulRoute2"  role="menu">',i=0;i<o.length;i++){var s=o[i],n=s.getAttribute("dir"),l=s.getAttribute("desc");a+="<li class='li2'><a href='javascript:routeload1("+e+", "+n+")'>"+l+"</a></li>"}a+="</ul></div>",document.getElementById("route_dir_options").innerHTML=a})}function deleteStopMarkers(){if(stopMarkers){for(i=0;i<stopMarkers.length;i++)map.removeLayer(stopMarkers[i]);stopMarkers.length=0}}function deleteClickMarkers(){if(clickMarkers){for(i=0;i<clickMarkers.length;i++)map.removeLayer(clickMarkers[i]);clickMarkers.length=0}"undefined"!=typeof positionMarkers[0]&&positionMarkers[0].setOpacity(0)}function deleteCloseStopMarkers(){if(closeStopMarkers){for(i=0;i<closeStopMarkers.length;i++)map.removeLayer(closeStopMarkers[i]);closeStopMarkers.length=0}}function deleteall(){deleteStopMarkers(),deleteClickMarkers(),deleteCloseStopMarkers(),closeStopMarkerNew&&map.removeLayer(closeStopMarkerNew),stopNewMarker&&map.removeLayer(stopNewMarker),markerGroup.clearLayers()}function routeload2(e){downloadUrl("//developer.trimet.org/ws/V1/routeConfig/appID/D17CB46A14E7BEE1CBA6598AA",function(e){for(var t=xmlParse(e),r=t.getElementsByTagName("route"),o=0;o<r.length;o++){var a=r[o];a.getAttribute("desc"),a.getAttribute("route")}})}function routeload1(e,t){routeload1nStopload(e,t);var r="//developer.trimet.org/ws/V1/routeConfig/route/"+e+"/dir/"+t+"/stops/true/appid/D17CB46A14E7BEE1CBA6598AA";deleteStopMarkers(),stopMarkers=[],downloadUrl(r,function(e){var t=xmlParse(e),r=t.getElementsByTagName("route")[0].getAttribute("desc"),o=t.getElementsByTagName("dir")[0].getAttribute("desc");$("#btnRoute1:first-child").text(r),$("#btnRoute2:first-child").text(o);var a=t.getElementsByTagName("stop");clearTimeout(vv);for(var i=0;i<a.length;i++){var s=a[i],n=(s.getAttribute("desc"),s.getAttribute("dir"),s.getAttribute("locid")),l=s.getAttribute("desc"),g=parseFloat(s.getAttribute("lat")),u=parseFloat(s.getAttribute("lng")),d=L.icon({iconUrl:"images/orange16.png",iconSize:[16,16],iconAnchor:[8,8]}),p={title:l,clickable:!0,icon:d};stopMarker=new L.marker([g,u],p),markerGroup.addLayer(stopMarker);var c="<b>Stop ID:</b>"+n+"<br /><b>Stop:</b>"+l+"<br/><a href='javascript:loadArrivalInfo("+n+")'>Next Arrivals</a>",m="<div><a href='javascript:loadArrivalInfo2("+n+")'>Scheduled Arrivals</a></div>",v=c+m;stopMarker.bindPopup(v).openPopup(),stopMarkers.push(stopMarker),map.addLayer(stopMarkers[i])}var k=new L.featureGroup(stopMarkers);map.fitBounds(k.getBounds())})}function routeload1nStopload(e,t){var r="//developer.trimet.org/ws/V1/routeConfig/route/"+e+"/dir/"+t+"/stops/true/appid/D17CB46A14E7BEE1CBA6598AA";downloadUrl(r,function(e){for(var t=xmlParse(e),r=t.getElementsByTagName("stop"),o='<div class="input-group-btn"><button type="button" id="btnRoute3" class="btn btn-default dropdown-toggle" data-toggle="dropdown">Choose Stop<span class="caret"></span></button><ul class="dropdown-menu" id="ulRoute3" role="menu">',a=0;a<r.length;a++){var i=r[a],s=i.getAttribute("locid"),n=i.getAttribute("desc"),l=i.getAttribute("lat"),g=i.getAttribute("lng"),u=l+","+g+","+s;o+="<li class='li3'><a href='javascript:routeStopload("+u+")'>"+n+"</a></li>"}document.getElementById("routeStop_dir_options").innerHTML=o+"</ul></div>"})}function routeStopload(e,t,r){closeStopMarkerNew&&map.removeLayer(closeStopMarkerNew),stopNewMarker&&map.removeLayer(stopNewMarker);var o,a,i,s;console.log(r);var n="//developer.trimet.org/ws/v2/arrivals/locids/"+r+"/appid/D17CB46A14E7BEE1CBA6598AA/json/false";downloadUrl(n,function(e){a="";var t=xmlParse(e),r=t.getElementsByTagName("location"),o=r[0].getAttribute("desc"),i=r[0].getAttribute("dir");a="<b>"+o+": "+i+"</b><br />"}),downloadUrl(n,function(e){var t=xmlParse(e),r=t.getElementsByTagName("arrival");i="";for(var o=0;o<r.length;o++){var a=r[o],s=a.getAttribute("route"),n=a.getAttribute("dir"),l=a.getAttribute("shortSign"),g=(a.getAttribute("scheduled"),a.getAttribute("estimated")),u=a.getAttribute("status");if("estimated"==u){var d=new Date(Number(g)),p=d.getHours()<10?"0"+d.getHours():d.getHours(),c=d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes(),m=p+":"+c;a.getAttribute("dir");i+="<div><a href='javascript:routeload1("+s+","+n+")'>"+l+"</a>: "+m+"</div>"}}console.log("Estimated"+i)}),downloadUrl(n,function(r){var n=xmlParse(r),l=n.getElementsByTagName("detour");s="";for(var g=0;g<l.length;g++){var u=l[g],d=u.getAttribute("begin"),p=u.getAttribute("end"),c=u.getAttribute("desc");if(c){var m=new Date(Number(d));console.log(m);var v=m.getDate()+"-"+(m.getMonth()+1)+"-"+m.getFullYear(),k=m.getHours()<10?"0"+m.getHours():m.getHours(),b=m.getMinutes()<10?"0"+m.getMinutes():m.getMinutes(),M=k+":"+b;v=v+" "+M;var h=new Date(Number(p)),f=h.getDate()+"-"+(h.getMonth()+1)+"-"+h.getFullYear(),A=h.getHours()<10?"0"+h.getHours():h.getHours(),w=h.getMinutes()<10?"0"+h.getMinutes():h.getMinutes(),S=A+":"+w;f=f+" "+S,s+="<div> Detour (from:"+v+" to: "+f+"): "+c+"</div>"}}o=a+i+"<br/>"+s;var y=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});stopNewMarker=new L.marker([e,t],{icon:y}),markerGroup.addLayer(stopNewMarker),map.addLayer(stopNewMarker),stopNewMarker.bindPopup(o).openPopup()}),map.setView([e,t],18)}function initialize(){function e(e){var t=e.latlng.toString().slice(7).split(", ")[0],r=e.latlng.toString().split(", ")[1].replace(")","");deleteClickMarkers();var o=L.icon({iconUrl:"./images/redman1.png",shadowUrl:"./images/redman1_shadow.png",iconSize:[40,40],shadowSize:[38,43],iconAnchor:[22,42],shadowAnchor:[12,44],popupAnchor:[0,-40]});clickMarker=new L.marker([t,r],{draggable:!0,icon:o}),clickMarker.on("dragend",function(e){console.log("it is dragged");var t=e.target.getLatLng().toString().slice(7).split(", ")[0],r=e.target.getLatLng().toString().split(", ")[1].replace(")","");loadCloseStops(t,r)}),clickMarkers.push(clickMarker),markerGroup.addLayer(clickMarker),map.addLayer(clickMarkers[0]),loadCloseStops(t,r),map.setView(e.latlng,16)}function t(e){deleteClickMarkers();var t=e.latlng.toString().slice(7).split(", ")[0],r=e.latlng.toString().split(", ")[1].replace(")",""),o=L.icon({iconUrl:"./images/redman1.png",shadowUrl:"./images/redman1_shadow.png",iconSize:[40,40],shadowSize:[38,43],iconAnchor:[22,42],shadowAnchor:[12,44],popupAnchor:[0,-40]});clickMarker=new L.marker([t,r],{icon:o,draggable:!0}),clickMarker.on("dragend",function(e){console.log("it is dragged");var t=e.target.getLatLng().toString().slice(7).split(", ")[0],r=e.target.getLatLng().toString().split(", ")[1].replace(")","");loadCloseStops(t,r)}),clickMarkers.push(clickMarker),markerGroup.addLayer(clickMarker),map.addLayer(clickMarkers[0]),loadCloseStops(t,r)}function r(e){alert(e.message)}$("ul").on("click","li.li1 a",function(){$("#btnRoute1:first-child").text($(this).text())}),$("ul").on("click","li.li2 a",function(){$("#btnRoute2:first-child").text($(this).text())}),$("ul").on("click","li.li3 a",function(){$("#btnRoute3:first-child").text($(this).text())}),map=L.map("map_canvas").setView([45.529,-122.662],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="//osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map),new L.Control.GeoSearch({provider:new L.GeoSearch.Provider.Google,position:"bottomleft",showMarker:!0}).addTo(map),map.on("geosearch_showlocation",function(e){thisLat=e.Location.X,thisLon=e.Location.Y,console.log(thisLat+", "+thisLon),loadCloseStops(thisLat,thisLon),"undefined"!=typeof positionMarkers[0]&&(console.log("set opacity as 0.9"),positionMarkers[0].setOpacity(1))}),map.on("click",e),map.locate({setView:!0,maxZoom:16}),map.on("locationfound",t),map.on("locationerror",r),$("#leaflet-control-geosearch-qry").attr("placeholder","Type an address to search nearby stops or click anywhere"),$("#leaflet-control-geosearch-qry").hide(),$("#leaflet-control-geosearch-qry").css("padding","0px"),$(".leaflet-bottom.leaflet-left").css("bottom",""),$(".leaflet-bottom.leaflet-left").css("top","108px"),routelist("none")}function searchOpen(){$("#leaflet-control-geosearch-qry").toggle()}function loadCloseStops(e,t){deleteCloseStopMarkers();var r="//developer.trimet.org/ws/V1/stops/ll/"+t+","+e+"/feet/500/appid/D17CB46A14E7BEE1CBA6598AA/json/false";downloadUrl(r,function(r){var o=xmlParse(r),a=o.getElementsByTagName("location"),i="";if(a.length>0)for(var s=0;s<a.length;s++){var n=a[s],l=n.getAttribute("desc"),g=n.getAttribute("dir"),u=n.getAttribute("lat"),d=n.getAttribute("lng"),p=n.getAttribute("locid");s1="<div>"+l+" ("+g+") <br /><a href='javascript:loadArrivalInfo("+p+")'>Next Arrivals</a></div>",s2="<div><a href='javascript:loadArrivalInfo2("+p+")'>Scheduled Arrivals</a></div>",i=s1+s2;var c=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});closeStopMarker=new L.marker([u,d],{icon:c}),closeStopMarker.bindPopup(i).openPopup(),closeStopMarkers.push(closeStopMarker),markerGroup.addLayer(closeStopMarkers[s]),map.addLayer(closeStopMarkers[s])}else{console.log("none");var m=L.popup(),v=L.latLng(e,t);m.setLatLng(v).setContent("There is no stops nearby."),clickMarker.bindPopup(m),clickMarker.openPopup()}}),$("#leaflet-control-geosearch-qry").hide()}function loadArrivalInfo(e){closeStopMarkerNew&&map.removeLayer(closeStopMarkerNew),stopNewMarker&&map.removeLayer(stopNewMarker);var t,r,o,a,i="//developer.trimet.org/ws/v2/arrivals/locids/"+e+"/appid/D17CB46A14E7BEE1CBA6598AA/json/false";downloadUrl(i,function(e){r="";var t=xmlParse(e),o=t.getElementsByTagName("location"),a=o[0].getAttribute("desc"),i=o[0].getAttribute("dir"),s=o[0].getAttribute("lat"),n=o[0].getAttribute("lng");r="<b>"+a+": "+i+"</b><br />";var l=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});closeStopMarkerNew=new L.marker([s,n],{icon:l}),markerGroup.addLayer(closeStopMarkerNew)}),downloadUrl(i,function(e){var t=xmlParse(e),r=t.getElementsByTagName("arrival");o="";for(var a=0;a<r.length;a++){var i=r[a],s=i.getAttribute("route"),n=i.getAttribute("dir"),l=i.getAttribute("shortSign"),g=(i.getAttribute("scheduled"),i.getAttribute("estimated")),u=i.getAttribute("status");if("estimated"==u){var d=new Date(Number(g));console.log(d);var p=d.getHours()<10?"0"+d.getHours():d.getHours(),c=d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes(),m=p+":"+c;i.getAttribute("dir");o+="<div><a href='javascript:routeload1("+s+","+n+")'>"+l+"</a>: "+m+"</div>"}}}),downloadUrl(i,function(e){var i=xmlParse(e),s=i.getElementsByTagName("detour");a="";for(var n=0;n<s.length;n++){var l=s[n],g=l.getAttribute("begin"),u=l.getAttribute("end"),d=l.getAttribute("desc");if(d){var p=new Date(Number(g));console.log(p);var c=p.getDate()+"-"+(p.getMonth()+1)+"-"+p.getFullYear(),m=p.getHours()<10?"0"+p.getHours():p.getHours(),v=p.getMinutes()<10?"0"+p.getMinutes():p.getMinutes(),k=m+":"+v;c=c+" "+k;var b=new Date(Number(u)),M=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),h=b.getHours()<10?"0"+b.getHours():b.getHours(),f=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes(),A=h+":"+f;M=M+" "+A,a+="<div> Detour (from:"+c+" to: "+M+"): "+d+"</div>"}}t=r+o+"<br/>"+a,map.addLayer(closeStopMarkerNew),closeStopMarkerNew.bindPopup(t).openPopup()})}function loadArrivalInfo2(e){closeStopMarkerNew&&map.removeLayer(closeStopMarkerNew),stopNewMarker&&map.removeLayer(stopNewMarker);var t,r,o,a,i=(new Date).getTime(),s=(new Date).getTime();s+=864e5;var n="//developer.trimet.org/ws/v2/arrivals/locids/"+e+"/appid/D17CB46A14E7BEE1CBA6598AA/json/false/begin/"+i+"/end/"+s;downloadUrl(n,function(e){r="";var t=xmlParse(e),o=t.getElementsByTagName("location"),a=o[0].getAttribute("desc"),i=o[0].getAttribute("dir"),s=o[0].getAttribute("lat"),n=o[0].getAttribute("lng");r="<b>"+a+": "+i+"</b><br />";var l=L.icon({iconUrl:"images/bus46.png",iconSize:[46,46],iconAnchor:[23,46],popupAnchor:[0,-34],shadowUrl:"images/bus46_shadow.png",shadowSize:[72,46],shadowAnchor:[25,46]});closeStopMarkerNew=new L.marker([s,n],{icon:l}),markerGroup.addLayer(closeStopMarkerNew)}),downloadUrl(n,function(e){var t=xmlParse(e),r=t.getElementsByTagName("arrival");o="";for(var a=0;a<r.length;a++){var i=r[a],s=i.getAttribute("route"),n=i.getAttribute("dir"),l=i.getAttribute("shortSign"),g=i.getAttribute("scheduled"),u=i.getAttribute("status");if("scheduled"==u){var d=new Date(Number(g)),p=d.getHours()<10?"0"+d.getHours():d.getHours(),c=d.getMinutes()<10?"0"+d.getMinutes():d.getMinutes(),m=p+":"+c;i.getAttribute("dir");o+="<div><a href='javascript:routeload1("+s+","+n+")'>"+l+"</a>: "+m+"</div>"}}}),downloadUrl(n,function(e){var i=xmlParse(e),s=i.getElementsByTagName("detour");a="";for(var n=0;n<s.length;n++){var l=s[n],g=l.getAttribute("begin"),u=l.getAttribute("end"),d=l.getAttribute("desc");if(d){var p=new Date(Number(g));console.log(p);var c=p.getDate()+"-"+(p.getMonth()+1)+"-"+p.getFullYear(),m=p.getHours()<10?"0"+p.getHours():p.getHours(),v=p.getMinutes()<10?"0"+p.getMinutes():p.getMinutes(),k=m+":"+v;c=c+" "+k;var b=new Date(Number(u)),M=b.getDate()+"-"+(b.getMonth()+1)+"-"+b.getFullYear(),h=b.getHours()<10?"0"+b.getHours():b.getHours(),f=b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes(),A=h+":"+f;M=M+" "+A,a+="<div> Detour (from:"+c+" to: "+M+"): "+d+"</div>"}}t=r+o+"<br/>"+a,map.addLayer(closeStopMarkerNew),closeStopMarkerNew.bindPopup(t).openPopup()})}function rad(e){return e*Math.PI/180}function find_closest_marker(e){if("undefined"!=typeof e.latLng)var t=e.latLng.lat(),r=e.latLng.lng();else var t=e.getPosition().lat(),r=e.getPosition().lng();var o=6371,a=[],s=-1;for(i=0;i<allBusStopMarkers.length;i++){var n=allBusStopMarkers[i].getPosition().lat(),l=allBusStopMarkers[i].getPosition().lng(),g=rad(n-t),u=rad(l-r),d=Math.sin(g/2)*Math.sin(g/2)+Math.cos(rad(t))*Math.cos(rad(t))*Math.sin(u/2)*Math.sin(u/2),p=2*Math.atan2(Math.sqrt(d),Math.sqrt(1-d)),c=o*p;a[i]=c,(-1==s||c<a[s])&&(s=i)}var m=allBusStopMarkers[s].getTitle();stopload(m)}function showHelp(){return $("div").filter(".helpCallout").is(":visible")?void $("div").filter(".helpCallout").fadeOut(100):void $("div").filter(".helpCallout").fadeIn(100)}var markers=[],stopMarkers=[],closeStopMarkers=[],addressMarkers=[],allBusStopMarkers=[],closeStopMarkers=[],clickMarkers=[],polylines=[],map,geocoder,marker,addressMarker,clickMarker,stopTitle,gTag,gAgency,tt,vv,stopMarker,closeStopMarker,closeStopMarkerNew,stopNewMarker,markerGroup=L.layerGroup();$(function(){$("#dialog").dialog({width:800,modal:!0,stack:!1})});